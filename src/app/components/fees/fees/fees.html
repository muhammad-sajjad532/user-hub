<div class="dashboard-wrapper">
  
  <!-- Sidebar -->
  <aside class="sidebar" [class.collapsed]="isSidebarCollapsed">
    <div class="logo-section">
      <div class="logo">
        <i class="bi bi-mortarboard-fill"></i>
      </div>
      <h3 class="logo-text" *ngIf="!isSidebarCollapsed">School MS</h3>
    </div>

    <nav class="sidebar-menu">
      <a href="javascript:void(0)" class="menu-item" [class.active]="activeMenu === 'dashboard'" (click)="setActiveMenu('dashboard')">
        <i class="bi bi-grid-fill"></i>
        <span *ngIf="!isSidebarCollapsed">Dashboard</span>
      </a>
      <a href="javascript:void(0)" class="menu-item" [class.active]="activeMenu === 'students'" (click)="setActiveMenu('students')">
        <i class="bi bi-people-fill"></i>
        <span *ngIf="!isSidebarCollapsed">Students</span>
      </a>
      <a href="javascript:void(0)" class="menu-item" [class.active]="activeMenu === 'teachers'" (click)="setActiveMenu('teachers')">
        <i class="bi bi-person-badge-fill"></i>
        <span *ngIf="!isSidebarCollapsed">Teachers</span>
      </a>
      <a href="javascript:void(0)" class="menu-item" [class.active]="activeMenu === 'classes'" (click)="setActiveMenu('classes')">
        <i class="bi bi-book-fill"></i>
        <span *ngIf="!isSidebarCollapsed">Classes</span>
      </a>
      <a href="javascript:void(0)" class="menu-item" [class.active]="activeMenu === 'attendance'" (click)="setActiveMenu('attendance')">
        <i class="bi bi-calendar-check-fill"></i>
        <span *ngIf="!isSidebarCollapsed">Attendance</span>
      </a>
      <a href="javascript:void(0)" class="menu-item" [class.active]="activeMenu === 'fees'" (click)="setActiveMenu('fees')">
        <i class="bi bi-cash-coin"></i>
        <span *ngIf="!isSidebarCollapsed">Fee Management</span>
      </a>
      <a href="javascript:void(0)" class="menu-item" [class.active]="activeMenu === 'setting'" (click)="setActiveMenu('setting')">
        <i class="bi bi-gear-fill"></i>
        <span *ngIf="!isSidebarCollapsed">Settings</span>
      </a>
    </nav>

    <button class="logout-btn" (click)="onLogout()">
      <i class="bi bi-box-arrow-right"></i>
      <span *ngIf="!isSidebarCollapsed">Log Out</span>
    </button>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    
    <!-- Top Bar -->
    <header class="top-bar">
      <button class="menu-toggle" (click)="toggleSidebar()">
        <i class="bi bi-list"></i>
      </button>

      <div class="top-bar-right">
        <div class="notification-wrapper">
          <div class="notification-badge" (click)="toggleNotificationDropdown()">
            <i class="bi bi-bell-fill"></i>
            <span class="badge" *ngIf="notificationCount > 0">{{ notificationCount }}</span>
          </div>

          <div class="notification-dropdown" *ngIf="showNotificationDropdown">
            <div class="notification-header">
              <h3>Notifications</h3>
              <button class="mark-all-read" (click)="markAllAsRead()" *ngIf="notificationCount > 0">
                Mark all as read
              </button>
            </div>

            <div class="notification-list">
              <div *ngFor="let notification of notifications" 
                   class="notification-item" 
                   [class.unread]="!notification.read"
                   [class.notification-success]="notification.type === 'success'"
                   [class.notification-info]="notification.type === 'info'"
                   [class.notification-warning]="notification.type === 'warning'"
                   [class.notification-error]="notification.type === 'error'"
                   (click)="markAsRead(notification.id)">
                <div class="notification-icon">
                  <i class="bi" [ngClass]="notification.icon"></i>
                </div>
                <div class="notification-content">
                  <h4>{{ notification.title }}</h4>
                  <p>{{ notification.message }}</p>
                  <span class="notification-time">{{ getTimeAgo(notification.timestamp) }}</span>
                </div>
                <button class="delete-notification" (click)="deleteNotification(notification.id, $event)">
                  <i class="bi bi-x"></i>
                </button>
              </div>

              <div class="no-notifications" *ngIf="notifications.length === 0">
                <i class="bi bi-bell-slash"></i>
                <p>No notifications</p>
              </div>
            </div>
          </div>
        </div>

        <div class="user-profile">
          <img src="https://ui-avatars.com/api/?name={{ userName }}&background=3b82f6&color=fff" alt="User">
          <div class="user-info">
            <span class="user-name">{{ userName }}</span>
            <span class="user-role" [ngClass]="getRoleBadgeClass()">{{ userRole }}</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Attendance Content -->
    <div class="page-content">
      
      <!-- Page Header -->
      <div class="page-header">
        <div>
          <h2 class="page-title">Fee Management</h2>
          <p class="page-subtitle">Track and collect student fees</p>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="stats-grid" style="margin-bottom: 24px;">
        <div class="stat-card green">
          <div class="stat-icon">
            <i class="bi bi-cash-stack"></i>
          </div>
          <div class="stat-info">
            <h3 class="stat-label">Total Collected</h3>
            <p class="stat-value">₨{{ totalCollected.toLocaleString() }}</p>
          </div>
        </div>

        <div class="stat-card red">
          <div class="stat-icon">
            <i class="bi bi-exclamation-circle-fill"></i>
          </div>
          <div class="stat-info">
            <h3 class="stat-label">Total Pending</h3>
            <p class="stat-value">₨{{ totalPending.toLocaleString() }}</p>
          </div>
        </div>

        <div class="stat-card blue">
          <div class="stat-icon">
            <i class="bi bi-people-fill"></i>
          </div>
          <div class="stat-info">
            <h3 class="stat-label">Total Students</h3>
            <p class="stat-value">{{ totalStudents }}</p>
          </div>
        </div>

        <div class="stat-card purple">
          <div class="stat-icon">
            <i class="bi bi-graph-up-arrow"></i>
          </div>
          <div class="stat-info">
            <h3 class="stat-label">Collection %</h3>
            <p class="stat-value">{{ collectionPercentage }}%</p>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="filters-section">
        <div class="filter-group">
          <label>Status:</label>
          <select [(ngModel)]="selectedStatus" (change)="filterRecords()" class="form-control">
            <option value="all">All Status</option>
            <option value="paid">Paid</option>
            <option value="pending">Pending</option>
            <option value="partial">Partial</option>
          </select>
        </div>
        <div class="filter-group" style="flex: 1;">
          <label>Search:</label>
          <input type="text" [(ngModel)]="searchQuery" (input)="filterRecords()" class="form-control" placeholder="Search student...">
        </div>
      </div>

      <!-- Fee Records Table -->
      <div class="table-card">
        <table class="data-table">
          <thead>
            <tr>
              <th>Roll No</th>
              <th>Student Name</th>
              <th>Class</th>
              <th>Monthly Fee</th>
              <th>Paid</th>
              <th>Pending</th>
              <th>Last Payment</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of filteredRecords">
              <td>{{ record.rollNumber }}</td>
              <td>
                <div class="student-info">
                  <div class="student-avatar">{{ record.studentName.charAt(0) }}</div>
                  <span>{{ record.studentName }}</span>
                </div>
              </td>
              <td><span class="class-badge">{{ record.class }}</span></td>
              <td>₨{{ record.monthlyFee.toLocaleString() }}</td>
              <td class="text-success">₨{{ record.totalPaid.toLocaleString() }}</td>
              <td class="text-danger">₨{{ record.totalPending.toLocaleString() }}</td>
              <td>
                <div *ngIf="record.lastPaymentDate">
                  <div>{{ record.lastPaymentDate }}</div>
                  <small class="text-muted">₨{{ record.lastPaymentAmount.toLocaleString() }}</small>
                </div>
                <span *ngIf="!record.lastPaymentDate" class="text-muted">No payment</span>
              </td>
              <td>
                <span class="status-badge" 
                      [class.status-paid]="record.status === 'paid'"
                      [class.status-pending]="record.status === 'pending'"
                      [class.status-partial]="record.status === 'partial'">
                  {{ record.status }}
                </span>
              </td>
              <td>
                <button class="btn-primary" (click)="openPaymentModal(record)" *ngIf="record.totalPending > 0 && canCollect()" style="padding: 8px 16px; font-size: 13px;">
                  <i class="bi bi-cash-coin"></i>
                  Collect
                </button>
                <span *ngIf="record.totalPending === 0" class="text-success">✓ Paid</span>
                <span *ngIf="record.totalPending > 0 && !canCollect()" class="text-muted">No permission</span>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="no-data" *ngIf="filteredRecords.length === 0">
          <i class="bi bi-inbox"></i>
          <p>No fee records found</p>
        </div>
      </div>

    </div>
  </main>

</div>

<!-- Payment Collection Modal -->
<div class="modal-overlay" *ngIf="showPaymentModal" (click)="closePaymentModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Collect Fee Payment</h3>
      <button class="modal-close" (click)="closePaymentModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    
    <div class="modal-body" *ngIf="selectedRecord">
      <div class="payment-info">
        <h4>{{ selectedRecord.studentName }}</h4>
        <p>Class: {{ selectedRecord.class }} | Roll No: {{ selectedRecord.rollNumber }}</p>
      </div>

      <div class="fee-summary">
        <div class="fee-item">
          <span>Monthly Fee:</span>
          <strong>₨{{ selectedRecord.monthlyFee.toLocaleString() }}</strong>
        </div>
        <div class="fee-item">
          <span>Total Paid:</span>
          <strong class="text-success">₨{{ selectedRecord.totalPaid.toLocaleString() }}</strong>
        </div>
        <div class="fee-item">
          <span>Total Pending:</span>
          <strong class="text-danger">₨{{ selectedRecord.totalPending.toLocaleString() }}</strong>
        </div>
      </div>

      <div class="form-group">
        <label>Payment Amount (₨) *</label>
        <input type="number" [(ngModel)]="paymentAmount" class="form-control" [max]="selectedRecord.totalPending" placeholder="Enter amount">
      </div>

      <div class="form-group">
        <label>Payment Date *</label>
        <input type="date" [(ngModel)]="paymentDate" class="form-control">
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closePaymentModal()">Cancel</button>
      <button class="btn-primary" (click)="collectPayment()">
        <i class="bi bi-cash-coin"></i>
        Collect Payment
      </button>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="success-modal-overlay" *ngIf="showSuccessModal">
  <div class="success-modal">
    <div class="success-icon-wrapper">
      <i class="bi" [ngClass]="successIcon"></i>
    </div>
    <h3 class="success-title">Success!</h3>
    <p class="success-message">{{ successMessage }}</p>
    <button class="btn-success" (click)="closeSuccessModal()">OK</button>
  </div>
</div>
